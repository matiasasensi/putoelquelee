<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR.js Stable Animation</title>

  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin: 0; overflow: hidden; }

    #ui {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      text-align: center;
      color: white;
      font-family: sans-serif;
    }

    #countBtn {
      width: 120px;
      height: 120px;
      background: url("materiales/plus1.png") no-repeat center;
      background-size: contain;
      border: none;
      background-color: transparent;
      cursor: pointer;
    }
  </style>
</head>

<body>

<div id="ui">
  <button id="countBtn"></button>
  <p>Score: <span id="score">0</span></p>
</div>

<a-scene embedded arjs="debugUIEnabled:false">

  <a-assets>
    <audio id="clickSound" src="materiales/click.mp3" preload="auto"></audio>
    <a-asset-item id="mogusModel" src="materiales/fakemogus.glb"></a-asset-item>
  </a-assets>

  <a-marker preset="hiro" id="marker">
    <a-entity
      id="fakemogus"
      gltf-model="#mogusModel"
      scale="0.5 0.5 0.5"
      rotation="0 0 90"
      sound="src:#clickSound; volume:3">
    </a-entity>
  </a-marker>

  <a-entity camera></a-entity>
</a-scene>

<script>
  let score = 0;
  let markerVisible = false;

  const btn = document.getElementById("countBtn");
  const scoreDisplay = document.getElementById("score");
  const model = document.getElementById("fakemogus");
  const marker = document.getElementById("marker");

  marker.addEventListener("markerFound", () => {
    markerVisible = true;
  });

  marker.addEventListener("markerLost", () => {
    markerVisible = false;
  });

  btn.addEventListener("click", () => {
    if (!markerVisible) return;

    score++;
    scoreDisplay.textContent = score;

    // ðŸ”¥ RESET DURO DEL MIXER (esto arregla el bug)
    model.removeAttribute("animation-mixer");

    setTimeout(() => {
      model.setAttribute("animation-mixer", {
        clip: "*",
        loop: "once",
        clampWhenFinished: true
      });
    }, 0);

    // Sonido
    const sound = model.components.sound;
    if (sound) {
      sound.stopSound();
      sound.playSound();
    }
  });
</script>

</body>
</html>
